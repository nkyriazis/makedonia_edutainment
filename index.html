<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Νομοί & Πρωτεύουσες Μακεδονίας – Παιχνίδι μνήμης + Διαδραστικός χάρτης</title>

  <!-- Leaflet CSS (κύριο CDN) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous"/>

  <style>
    /* ---- Global interaction guard: hand cursor everywhere ---- */
    html, body, * { cursor: pointer !important; }
    /* Disable text selection and image dragging globally */
    html, body, * { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
  img { -webkit-user-drag: none; }
    /* Prevent clicking Leaflet UI controls/markers; allow wheel to pass through */
    .leaflet-control { pointer-events: none !important; }
    .leaflet-marker-icon, .leaflet-marker-shadow { pointer-events: none !important; }
    /* Keep the map itself responsive to wheel for zoom */
    #map, .leaflet-container { cursor: pointer !important; }
    /* ---- 16:9 stage & scaling ---- */
    html, body { height: 100%; }
    body { margin:0; background:#0b1020; }
    .stage-outer {
      position: fixed; inset: 0; display: grid; place-items: center;
      background: linear-gradient(120deg,#0b1020,#0f172a 50%,#0b1020);
      overflow: hidden;
    }
    /* Letterboxing bars (visual only) */
    .stage-outer::before {
      content: ""; position: absolute; inset: 0; pointer-events: none;
      background: radial-gradient(1200px 600px at 50% 50%, rgba(255,255,255,.04), transparent 60%);
    }
    .stage {
      position: absolute; left: 50%; top: 50%;
      width: 1280px; height: 720px; /* Base 16:9 design resolution */
      transform: translate(-50%, -50%) scale(1);
      transform-origin: center center;
      display: grid; grid-template-rows: auto 1fr; gap:12px;
    }

    /* Orientation overlay for unsupported orientations */
    #orientation-overlay {
      position: fixed; inset: 0; display: none; align-items: center; justify-content: center; flex-direction: column;
      background: #0b1020; color: #e5e7eb; z-index: 9999; text-align: center; padding: 24px;
    }
    #orientation-overlay .box {
      max-width: 520px; border: 1px solid #334155; border-radius: 16px; padding: 18px 20px; background: #0b1220;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    #orientation-overlay h2 { margin: 0 0 8px 0; font-size: 18px; }
    #orientation-overlay p { margin: 4px 0 0 0; font-size: 14px; color: #cbd5e1; }

    :root { --bg:#0f172a; --panel:#111827; --muted:#9ca3af; --text:#e5e7eb; --brand:#22c55e; --brand-2:#38bdf8; --danger:#f43f5e; --ok:#10b981; --card:#0b1220; }
    * { box-sizing: border-box; }
    /* Move previous body layout into stage to keep proportions */
    .stage { color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,'Noto Sans',sans-serif; }
    header { padding:14px 18px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; border-bottom:1px solid #1f2937; position:sticky; top:0; z-index:10; backdrop-filter:blur(6px); }
  header h1 { font-size:22px; margin:0; font-weight:700; letter-spacing:.3px; }
    header .sub { color:var(--muted); font-size:12px; }
    header .controls { margin-left:auto; display:flex; gap:8px; flex-wrap:wrap; }
    button { border:1px solid #334155; background:#0b1220; color:var(--text); padding:8px 12px; border-radius:12px; cursor:pointer; transition:.08s transform,.2s background,.2s border-color,.2s box-shadow; font-weight:600; }
    button:hover { transform:translateY(-1px); border-color:#3b82f6; box-shadow:0 6px 20px rgba(0,0,0,.35), inset 0 0 0 1px rgba(59,130,246,.2); }
    button.primary { background:linear-gradient(135deg,#2563eb,#38bdf8); border-color:transparent; color:#fff; }

    /* Διάταξη: αριστερά ο Χάρτης πλήρους ύψους, δεξιά το Παιχνίδι */
    main { display:grid; grid-template-columns: 1.25fr 1fr; gap:14px; padding:0 14px 18px; align-items: stretch; }
    /* Force stable 2-column layout inside stage regardless of viewport */
    .stage main { grid-template-columns: 1.25fr 1fr !important; }

  .panel { background:linear-gradient(180deg,#0c1224,#0a0f1e); border:1px solid #1f2937; border-radius:18px; overflow:hidden; height:100%; min-height:0; display:grid; grid-template-rows:auto 1fr; }
    .panel h2 { margin:0; padding:12px 14px; font-size:14px; letter-spacing:.2px; color:#9ca3af; border-bottom:1px solid #1f2937; background:#0b1220; }

  /* Χάρτης: γεμίζει όλη την αριστερή στήλη */
  #map { height:100%; width:100%; position:relative; min-height: 120px; }
  .map-fallback { display:grid; place-items:center; height:100%; color:#cbd5e1; font-size:14px; padding:12px; text-align:center; }
    .legend { position:absolute; bottom:10px; left:10px; background:#0b1220d0; padding:8px 10px; border-radius:12px; border:1px solid #1f2937; font-size:12px; color:#cbd5e1; z-index: 500; }
    .legend b { color:#e5e7eb; }

    /* Παιχνίδι δεξιά */
    .game-wrapper { grid-template-rows:auto 1fr auto auto; }
    /* HUD: 2x2 grid so pills have enough width and fixed row height for stability */
    .hud {
      display:grid; grid-template-columns: 1fr 1fr; grid-auto-rows: 38px; gap:10px;
      align-items:stretch; padding:10px 14px; border-bottom:1px solid #1f2937; background:#0b1220;
      min-height: calc(38px*2 + 10px + 20px); /* two rows + gap + vertical padding */
    }
    .hud .pill {
      background:#0b1220; border:1px solid #1f2937; padding:6px 10px; border-radius:12px; color:#cbd5e1; font-size:12px;
      white-space:nowrap; line-height:1.2; display:flex; align-items:center; justify-content:center; overflow:hidden; text-overflow:ellipsis;
    }
    .hud .step { background:#0b1220; border:1px dashed #334155; }
  /* Keep the step pill from expanding the layout: flex it, allow shrink, clip with ellipsis */
  /* Step pill is a grid item now; ensure clipping */
  #step-pill { overflow: hidden; text-overflow: ellipsis; }
  /* Stabilize numeric widths so other pills don't grow and shrink */
  .hud .pill b { font-variant-numeric: tabular-nums; display:inline-block; text-align:right; }
  #moves { min-width: 3ch; }
  #pairs { min-width: 2ch; }
  /* Keep mode pill width stable between labels */
  #mode-pill { text-align: center; }

    .boards { display:grid; grid-template-columns: 1fr 1fr; gap:12px; padding:12px; height:100%; }
  /* Keep two subpanels side by side within the fixed stage */
  .stage .boards{ grid-template-columns:1fr 1fr !important; grid-auto-rows:initial !important; }

    .subpanel { display:grid; grid-template-rows:auto 1fr auto; gap:8px; min-height:0; border:1px solid #1f2937; border-radius:14px; padding:10px; background:#0b1220; }
    .subpanel h3 { margin:0; font-size:13px; color:#cbd5e1; font-weight:600; }

    /* Κάθε board: responsive μέγεθος καρτών μέσω CSS μεταβλητών που ενημερώνει το JS */
    .board { --tile-w: 140px; --tile-fs: clamp(12px, calc(var(--tile-w)*0.18), 28px); --tag-fs: clamp(9px, calc(var(--tile-w)*0.08), 12px); padding:6px; display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; overflow:auto; height:100%; align-content:start; }

    .card { perspective:800px; aspect-ratio: 3 / 2; height:auto; }
    .card-inner { position:relative; height:100%; transform-style:preserve-3d; transition:transform .32s ease; }
    .card.flipped .card-inner { transform:rotateY(180deg); }
    .face { position:absolute; inset:0; display:grid; place-items:center; backface-visibility:hidden; border-radius:14px; border:1px solid #1f2937; padding: 6px; text-align:center; font-size: var(--tile-fs); }
    .front { background:radial-gradient(120px 80px at 20% 15%, rgba(255,255,255,.08), transparent 60%), var(--card); }
    .back { background:linear-gradient(135deg,#2563eb, #38bdf8); transform:rotateY(180deg); color:#fff; font-weight:800; letter-spacing:.3px; }
    .tag { position:absolute; top:6px; right:6px; font-size:var(--tag-fs); background:#0b1220cc; border:1px solid #1f2937; padding:3px 6px; border-radius:999px; color:#cbd5e1; }

    /* Αποφυγή υπερχείλισης κειμένου στα πλακίδια σε μικρές οθόνες */
    .face { overflow: hidden; line-height: 1.12; }
    .face .label {
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 3; /* έως 3 γραμμές σε desktop */
      line-clamp: 3;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
      padding-inline: 4px;
      word-break: break-word;          /* παλιότερα engines */
      overflow-wrap: anywhere;         /* σύγχρονα browsers */
      hyphens: auto;                   /* συλλαβισμός (html lang="el") */
    }
    @media (max-width: 980px){
      .face .label{ -webkit-line-clamp: 2; line-clamp: 2; }
    }

    .status {
      padding: 0 14px; font-size:12px; color:#cbd5e1; border-top:1px solid #1f2937; background:#0b1220;
      line-height: 1.2; height: 36px; display:flex; align-items:center;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .status .ok { color:var(--ok); } .status .warn { color:#f59e0b; } .status .err { color:#f43f5e; }
    .credits { font-size:11px; color:#9ca3af; padding:6px 12px 12px; }
    .credits a { color:#93c5fd; text-decoration:none; }
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <!-- Orientation guard overlay (shown on unsupported orientations) -->
  <div id="orientation-overlay" role="alert" aria-live="assertive">
    <div class="box">
      <h2>Απαιτείται οριζόντιος προσανατολισμός</h2>
      <p>Το παιχνίδι λειτουργεί σε σταθερή αναλογία 16:9. Περιστρέψτε τη συσκευή σας σε οριζόντιο προσανατολισμό.</p>
    </div>
  </div>

  <div class="stage-outer">
    <div class="stage" id="stage">
  <header>
    <h1>Νομοί &amp; Πρωτεύουσες της Μακεδονίας <span class="sub">(13)</span></h1>
    <div class="controls">
      <button class="primary" id="btn-new">Νέα παρτίδα</button>
      <button id="btn-study">Λειτουργία μελέτης</button>
      <button id="btn-show-all">Δείξε όλους τους μαρκαδόρους</button>
    </div>
  </header>

  <main>
    <section class="panel" aria-label="Διαδραστικός χάρτης" id="map-panel">
      <h2>Χάρτης</h2>
      <div id="map"></div>
      <div class="legend" id="legend">
        <b>Υπόμνημα</b><br/>
        • Μαρκαδόροι: πρωτεύουσες 13 νομών Μακεδονίας (Wikidata ή fallback)
      </div>
    </section>

    <section class="panel game-wrapper">
      <div class="hud">
        <span class="pill">Γυρίσματα: <b id="moves">0</b></span>
        <span class="pill">Ζευγάρια: <b id="pairs">0</b>/13</span>
        <span class="pill" id="mode-pill">Κανονικό</span>
        <span class="pill step" id="step-pill">Βήμα 1: διάλεξε Νομό ή Πρωτεύουσα</span>
      </div>
      <div class="boards">
        <div class="subpanel" id="panel-nomoi">
          <h3>Νομοί</h3>
          <div class="board" id="board-nomoi" aria-label="Κάρτες Νομών"></div>
          <div class="prompt" id="prompt-nomoi">Διάλεξε ένα Νομό.</div>
        </div>
        <div class="subpanel" id="panel-capitals">
          <h3>Πρωτεύουσες</h3>
          <div class="board" id="board-capitals" aria-label="Κάρτες Πρωτευουσών"></div>
          <div class="prompt" id="prompt-capitals">Ή διάλεξε μία Πρωτεύουσα.</div>
        </div>
      </div>
      <div class="status" id="status" aria-live="polite"></div>
      <div class="credits">
        Πηγές δεδομένων: Πρωτεύουσες από Βικιδεδομένα (SPARQL) με fallback τοπικές συντεταγμένες.
      </div>
    </section>
  </main>
    </div>
  </div>

  <script>
    "use strict";

    // ------------------------------
    // 0) Ασφαλής φόρτωση Leaflet
    // ------------------------------
    async function ensureLeafletCSS(){
      const has = Array.from(document.styleSheets).some(s => (s.href||'').includes('leaflet'))
               || Array.from(document.querySelectorAll('link[rel="stylesheet"]')).some(l => (l.href||'').includes('leaflet'));
      if (has) return;
      const hrefs=[
        'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css',
        'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css',
        'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css'
      ];
      for (const href of hrefs){
        try{ await new Promise((res,rej)=>{ const link=document.createElement('link'); link.rel='stylesheet'; link.href=href; link.crossOrigin='anonymous'; link.onload=()=>res(); link.onerror=()=>rej(); document.head.appendChild(link); }); return; }catch(e){}
      }
    }
    async function ensureLeaflet(){
      if (window.L) return true;
      const tries=[
        {src:'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js', integrity:'sha256-20nQCchB9co0qIjJZrkZkG0GZlC2LNf1q0x4H1Bf0XQ='},
        {src:'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js'},
        {src:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js'}
      ];
      for (const t of tries){
        try{ await new Promise((resolve,reject)=>{ const s=document.createElement('script'); s.src=t.src; s.async=true; s.crossOrigin='anonymous'; if(t.integrity) s.integrity=t.integrity; s.onload=()=>resolve(); s.onerror=()=>reject(); document.head.appendChild(s);}); if (window.L) return true; }catch(e){}
      }
      return false;
    }

    // ------------------------------
    // 1) Δεδομένα
    // ------------------------------
    const NOMOI_MAKEDONIAS=[
      { nomos:'Δράμας', capital:'Δράμα' },
      { nomos:'Καβάλας', capital:'Καβάλα' },
      { nomos:'Θεσσαλονίκης', capital:'Θεσσαλονίκη' },
      { nomos:'Κιλκίς', capital:'Κιλκίς' },
      { nomos:'Πέλλας', capital:'Έδεσσα' },
      { nomos:'Ημαθίας', capital:'Βέροια' },
      { nomos:'Πιερίας', capital:'Κατερίνη' },
      { nomos:'Σερρών', capital:'Σέρρες' },
      { nomos:'Χαλκιδικής', capital:'Πολύγυρος' },
      { nomos:'Κοζάνης', capital:'Κοζάνη' },
      { nomos:'Φλώρινας', capital:'Φλώρινα' },
      { nomos:'Καστοριάς', capital:'Καστοριά' },
      { nomos:'Γρεβενών', capital:'Γρεβενά' }
    ];

    const CAPITAL_COORDS_FALLBACK={
      'Δράμα':[41.1524,24.1469], 'Καβάλα':[40.9396,24.4018], 'Θεσσαλονίκη':[40.6401,22.9444], 'Κιλκίς':[40.9930,22.8743],
      'Έδεσσα':[40.8016,22.0470], 'Βέροια':[40.5244,22.2030], 'Κατερίνη':[40.2696,22.5060], 'Σέρρες':[41.0850,23.5470],
      'Πολύγυρος':[40.3778,23.4431], 'Κοζάνη':[40.3006,21.7896], 'Φλώρινα':[40.7819,21.4097], 'Καστοριά':[40.5197,21.2687], 'Γρεβενά':[40.0845,21.4274]
    };

    // ------------------------------
    // 2) Χάρτης / Μαρκαδόροι
    // ------------------------------
    let hasLeaflet=false; let map=null; let markersLayer=null; let statusEl=document.getElementById('status'); const stepPill=document.getElementById('step-pill');
    const markerByCapital=new Map(); // "Θεσσαλονίκη" -> Marker
    const markerByNomos=new Map();   // "Θεσσαλονίκης" -> Marker (της πρωτεύουσας)

    function flashStatus(html,tone='ok'){ statusEl.innerHTML=`<span class="${tone}">${html}</span>`; }

    async function loadCapitalsFromWikidata(){
      const cities=[...new Set(NOMOI_MAKEDONIAS.map(x=>x.capital))];
      const queries=cities.map(c=>`\"${c}\"`).join(' ');
      const sparql=`
        SELECT ?cityLabel ?coord WHERE {
          VALUES ?needle { ${queries} }
          SERVICE wikibase:mwapi {
            bd:serviceParam wikibase:endpoint "www.wikidata.org";
                             wikibase:api "EntitySearch";
                             mwapi:search ?needle;
                             mwapi:language "el".
            ?item wikibase:apiOutputItem mwapi:item.
          }
          ?item wdt:P625 ?coord.
          SERVICE wikibase:label { bd:serviceParam wikibase:language "el,en". }
          BIND(?needle AS ?cityLabel)
        }`;
      try{
        const res=await fetch('https://query.wikidata.org/sparql?format=json&query='+encodeURIComponent(sparql),{headers:{'Accept':'application/sparql-results+json'}});
        if(!res.ok) throw new Error('Wikidata HTTP '+res.status);
        const data=await res.json();
        const coords={};
        for (const b of data.results.bindings){
          const lab=b.cityLabel.value; const [lat,lon]=b.coord.value.replace('Point(','').replace(')','').split(' ').map(Number).reverse();
          coords[lab]=[lat,lon];
        }
        return coords;
      }catch(e){ console.warn('Wikidata coord lookup failed, using fallback',e); return {...CAPITAL_COORDS_FALLBACK}; }
    }

    function renderCapitalMarkers(coordsByCity){
      if(!hasLeaflet) return;
      markersLayer.clearLayers(); markerByCapital.clear(); markerByNomos.clear();
      for (const {nomos,capital} of NOMOI_MAKEDONIAS){
        const ll=coordsByCity[capital]||CAPITAL_COORDS_FALLBACK[capital]; if(!ll) continue;
        const m=L.marker(ll, {opacity:1}).addTo(markersLayer);
        m.options.opacity = 1;
        m.bindPopup(`<b>${capital}</b><br/>Πρωτεύουσα νομού ${nomos}`);
        markerByCapital.set(capital, m);
        markerByNomos.set(nomos, m);
      }
    }

    function applyCoordsToMarkers(coordsByCity){
      if(!hasLeaflet) return;
      for (const {nomos,capital} of NOMOI_MAKEDONIAS){
        const ll=coordsByCity[capital]||CAPITAL_COORDS_FALLBACK[capital]; if(!ll) continue;
        let m=markerByNomos.get(nomos);
        if (m){
          try{
            const cur=m.getLatLng();
            if (Math.abs(cur.lat-ll[0])>1e-5 || Math.abs(cur.lng-ll[1])>1e-5){ m.setLatLng(ll); }
          }catch{}
        } else {
          const nm=L.marker(ll,{opacity:1}).addTo(markersLayer);
          nm.options.opacity=1; nm.bindPopup(`<b>${capital}</b><br/>Πρωτεύουσα νομού ${nomos}`);
          markerByCapital.set(capital, nm); markerByNomos.set(nomos, nm);
        }
      }
    }

    function openMarkerForNomos(nomos){ const marker=markerByNomos.get(nomos); if(!marker) return; try{ marker.openPopup(); map.setView(marker.getLatLng(), 9, {animate:true}); }catch{} }
    function showOnlyMarkerForNomos(nomos){ const target=markerByNomos.get(nomos); if(!target) return; for (const m of markerByNomos.values()) { try{ m.setOpacity(0); m.options.opacity = 0; }catch{} } try{ target.setOpacity(1); target.options.opacity = 1; target.setZIndexOffset(1000); target.openPopup(); map.setView(target.getLatLng(), 9, {animate:true}); }catch{} }
    function showAllMarkers(){ for (const m of markerByNomos.values()) { try{ m.setOpacity(1); m.options.opacity = 1; m.setZIndexOffset(0);}catch{} } }

    // Helper: map auto-fit to include all markers ("extend" view)
    function areAllMarkersFullyVisible(){
      if (!hasLeaflet || !map || markerByNomos.size===0) return false;
      let allVisible=true; for (const m of markerByNomos.values()){ const op=m?.options?.opacity; if (typeof op==='number' && op<1){ allVisible=false; break; } }
      return allVisible;
    }
    function fitMapToAllMarkers(padding=30){
      if (!hasLeaflet || !map || markerByNomos.size===0) return;
      try{
        const pts=[]; for (const m of markerByNomos.values()){ try{ const ll=m.getLatLng(); if(ll) pts.push(ll); }catch{} }
        if (pts.length===0) return;
        if (pts.length===1){ map.setView(pts[0], 9, {animate:false}); return; }
        const b=L.latLngBounds(pts);
        map.fitBounds(b, {padding: [padding, padding], maxZoom: 10, animate:false});
      }catch{}
    }
    let fitBoundsScheduled=false;
    function scheduleFitMapToAllMarkers(){
      if (fitBoundsScheduled) return; fitBoundsScheduled=true;
      setTimeout(()=>{ fitBoundsScheduled=false; if (areAllMarkersFullyVisible()) { try{ fitMapToAllMarkers(); }catch{} } }, 60);
    }

    // ------------------------------
    // 3) Παιχνίδι μνήμης – Δύο πίνακες
    // ------------------------------
    const boardNomoi=document.getElementById('board-nomoi');
    const boardCaps=document.getElementById('board-capitals');
    const panelNomoi=document.getElementById('panel-nomoi');
    const panelCaps=document.getElementById('panel-capitals');
    const promptNomoi=document.getElementById('prompt-nomoi');
    const promptCaps=document.getElementById('prompt-capitals');
    const movesEl=document.getElementById('moves'); const pairsEl=document.getElementById('pairs'); const modePill=document.getElementById('mode-pill');

    let firstPick=null; let locked=false; let moves=0; let foundPairs=0; let studyMode=false; let activeType=null; // 'nomos' | 'capital' | null

    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
    function cardsNomoi(){ return NOMOI_MAKEDONIAS.map(({nomos})=>({type:'nomos', label:`Νομός ${nomos}`, key:nomos, tag:'Νομός'})); }
    function cardsCapitals(){ return NOMOI_MAKEDONΙΑΣ?.map(()=>[])??[]; /* guard for wrong symbol */ }
    function cardsCapitalsCorrect(){ return NOMOI_MAKEDONIAS.map(({nomos,capital})=>({type:'capital', label:capital, key:nomos, tag:'Πρωτεύουσα'})); }

    function makeCardEl(card, onClick){
      const cardEl=document.createElement('div'); cardEl.className='card';
      cardEl.dataset.type=card.type; cardEl.dataset.key=card.key; cardEl.dataset.label=card.label;
      cardEl.innerHTML=`<div class="card-inner"><div class="face front"><span class="tag">${card.tag}</span></div><div class="face back"><span class="label">${card.label}</span></div></div>`;
      cardEl.addEventListener('click',()=>onClick(cardEl,card));
      return cardEl;
    }

    function renderPanels(){
      boardNomoi.innerHTML=''; boardCaps.innerHTML='';
      shuffle(cardsNomoi()).forEach(c=>boardNomoi.appendChild(makeCardEl(c,(el,card)=>onPick('nomos',el,card))));
      shuffle(cardsCapitalsCorrect()).forEach(c=>boardCaps.appendChild(makeCardEl(c,(el,card)=>onPick('capital',el,card))));
      // reset state
      moves=0; foundPairs=0; firstPick=null; locked=false; activeType=null; movesEl.textContent='0'; pairsEl.textContent='0';
      setActiveType(null);
      flashStatus('Βήμα 1: Διάλεξε μία κάρτα από οποιονδήποτε πίνακα.','ok');
      try { map && map.invalidateSize(); } catch {}
      scheduleLayout();
    }

    function onPick(type, el, card){
      if(locked) return;
      if(el.classList.contains('flipped')) return;
      if(firstPick && firstPick.type===type){ flashStatus('Διάλεξε τώρα από τον <b>άλλο</b> πίνακα.','warn'); return; }

      // flip current
      el.classList.add('flipped');

      if(!firstPick){
        firstPick={type, el, card};
        stepPill.textContent = `Βήμα 2: βρες το ταίρι στον ${type==='nomos'?'πίνακα Πρωτευουσών':'πίνακα Νομών'}`;
        setActiveType(type==='nomos'?'capital':'nomos');
        if (type==='nomos') openMarkerForNomos(card.key); else { const nom = card.key; openMarkerForNomos(nom); }
        return;
      }

      // second pick
      locked=true; moves++; movesEl.textContent=String(moves);
      const a=firstPick; const b={type, el, card}; const isMatch=a.card.key===b.card.key;
      if(isMatch){
        foundPairs++; pairsEl.textContent=String(foundPairs);
        showOnlyMarkerForNomos(a.card.key);
        setTimeout(()=>{
          a.el.style.opacity=b.el.style.opacity=0.55; a.el.style.pointerEvents=b.el.style.pointerEvents='none';
          flashStatus(`Μπράβο! Ταίριαξες <b>${a.card.key}</b>`, 'ok');
          resetTurn();
          if(foundPairs===13){ stepPill.textContent='Τέλος! Όλα τα ζευγάρια ταιριάχτηκαν ✨'; }
        },380);
      } else {
        setTimeout(()=>{
          a.el.classList.remove('flipped'); b.el.classList.remove('flipped');
          flashStatus('Δεν ταιριάζουν – προσπάθησε ξανά!','warn');
          resetTurn();
        },650);
      }
    }

    function resetTurn(){ firstPick=null; locked=false; setActiveType(null); stepPill.textContent='Βήμα 1: διάλεξε Νομό ή Πρωτεύουσα'; }

    function setActiveType(t){
      activeType=t;
      const nomosActive = (t===null || t==='nomos');
      const capActive   = (t===null || t==='capital');
      panelNomoi.classList.toggle('disabled', !nomosActive);
      panelCaps. classList.toggle('disabled', !capActive);
      panelNomoi.classList.toggle('active', nomosActive && t!==null);
      panelCaps. classList.toggle('active', capActive && t!==null);
      promptNomoi.textContent = t==='nomos' ? 'Επίλεξε εδώ έναν Νομό.' : (t===null ? 'Διάλεξε έναν Νομό.' : 'Περίμενε: επίλεξε από Πρωτεύουσες.');
      promptCaps.textContent  = t==='capital' ? 'Επίλεξε εδώ μία Πρωτεύουσα.' : (t===null ? 'Ή διάλεξε μία Πρωτεύουσα.' : 'Περίμενε: επίλεξε από Νομούς.');
    }

    // ------------------------------
    // 4) Υπολογισμός διάταξης πλακιδίων και κλιμάκωση μεγέθους/γραμματοσειράς
    // ------------------------------
    function bestColumnsToFill(N, ar, W, H, gap){
      let best=N; for(let c=1;c<=N;c++){ const r=Math.ceil(N/c); const w=(W - (c-1)*gap)/c; const h=w*(1/ar); const totalH=r*h + (r-1)*gap; if (totalH <= H){ best=c; break; } } return Math.max(1, Math.min(N, best));
    }

    function layoutOneBoard(boardEl){
      const N=boardEl.children.length; if(!N) return;
      const cs=getComputedStyle(boardEl); const gap=parseFloat(cs.gap)||8; const W=boardEl.clientWidth; const H=boardEl.clientHeight; const AR=3/2;
      const cols=bestColumnsToFill(N, AR, W, H, gap);
      boardEl.style.gridTemplateColumns=`repeat(${cols}, 1fr)`;
      // Υπολογισμός πλάτους κάρτας για ρύθμιση font-size
      const tileW=(W - (cols-1)*gap)/cols; boardEl.style.setProperty('--tile-w', `${tileW}px`);
      const tileFS=Math.max(12, Math.min(28, tileW*0.18)); boardEl.style.setProperty('--tile-fs', `${tileFS}px`);
      const tagFS=Math.max(9, Math.min(12, tileW*0.08)); boardEl.style.setProperty('--tag-fs', `${tagFS}px`);
    }

    function layoutBoards(){ layoutOneBoard(boardNomoi); layoutOneBoard(boardCaps); }

    // Debounced / RAF-scheduled layout για αποφυγή ResizeObserver loop
    let layoutScheduled=false;
    function scheduleLayout(){
      if(layoutScheduled) return;
      layoutScheduled=true;
      requestAnimationFrame(()=>{ layoutScheduled=false; layoutBoards(); });
    }

    // ------------------------------
    // 4b) 16:9 fixed stage scaling and orientation guard (moved earlier to avoid TDZ)
    // ------------------------------
    const BASE_W=1280, BASE_H=720;
    function applyStageScale(){
      const stage=document.getElementById('stage'); if(!stage) return;
      const vw=window.innerWidth, vh=window.innerHeight; const scale=Math.min(vw/BASE_W, vh/BASE_H);
      stage.style.transform=`translate(-50%, -50%) scale(${scale})`;
    }
    function isMobileDevice(){
      return /Mobi|Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);
    }
    function inPortrait(){ return window.innerHeight > window.innerWidth; }
    function updateOrientationGuard(){
      const overlay=document.getElementById('orientation-overlay');
      const mustLandscape = true; // enforce landscape for the 16:9 game
      const show = isMobileDevice() && mustLandscape && inPortrait();
      overlay.style.display = show ? 'flex' : 'none';
      // Disable page scroll when overlay visible
      document.documentElement.style.overflow = show ? 'hidden' : '';
      document.body.style.overflow = show ? 'hidden' : '';
    }
    async function tryLockLandscape(){
      if(!(screen && screen.orientation && screen.orientation.lock)) return false;
      try{
        await screen.orientation.lock('landscape');
        return true;
      }catch{
        return false;
      }
    }

    // ------------------------------
    // 5) Εκκίνηση εφαρμογής
    // ------------------------------
    async function startApp(){
      // Kiosk-like interaction guard first
      setupInteractionGuards();
      // Initial stage scale
      applyStageScale();
      updateOrientationGuard();

      await ensureLeafletCSS(); hasLeaflet=await ensureLeaflet();
      if(hasLeaflet){
        map=L.map('map',{ zoomControl:true, scrollWheelZoom:true }).setView([40.7,22.5],7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:18, attribution:'&copy; OpenStreetMap συνεισφέροντες' }).addTo(map);
        markersLayer=L.layerGroup().addTo(map);
        // Allow only wheel zoom; disable other mouse interactions on the map
        try{
          map.dragging.disable();
          map.doubleClickZoom.disable();
          map.boxZoom.disable();
          map.keyboard.disable();
          if (map.tap) map.tap.disable();
          map.touchZoom.disable();
          map.scrollWheelZoom.enable();
        }catch{}
        // Invalidate size a couple of times to cover first-render under transformed parent
        setTimeout(()=>{ try{ map.invalidateSize(); }catch{} scheduleLayout(); }, 80);
        setTimeout(()=>{ try{ map.invalidateSize(); }catch{} }, 200);
        // Observe map container size changes to keep tiles positioned correctly
        try {
          const mapEl=document.getElementById('map');
          if (mapEl && 'ResizeObserver' in window){
            const mro=new ResizeObserver(()=>{ try{ map && map.invalidateSize(); }catch{} });
            mro.observe(mapEl);
          }
        } catch {}
        renderCapitalMarkers(CAPITAL_COORDS_FALLBACK); showAllMarkers(); scheduleFitMapToAllMarkers();
      } else {
        const mapEl=document.getElementById('map');
        if (mapEl){
          mapEl.innerHTML = '<div class="map-fallback">Δεν ήταν δυνατή η φόρτωση του χάρτη (Leaflet).<br/>Ενδέχεται να φταίει το δίκτυο, το CDN ή κάποιο blocker.<br/><small>Το παιχνίδι λειτουργεί κανονικά χωρίς χάρτη.</small></div>';
        }
        flashStatus('⚠️ Δεν φορτώθηκε ο χάρτης (Leaflet). Το παιχνίδι λειτουργεί κανονικά χωρίς χάρτη.','warn');
      }

      try {
        const ro=new ResizeObserver(()=>scheduleLayout());
        ro.observe(document.querySelector('.boards'));
        ro.observe(boardNomoi);
        ro.observe(boardCaps);
      } catch {}

      renderBoard();

  try{ const coords=await loadCapitalsFromWikidata(); applyCoordsToMarkers(coords); flashStatus('Οι μαρκαδόροι ενημερώθηκαν με ακριβέστερες συντεταγμένες.','ok'); }catch(e){ console.warn(e); }
  // After coordinates update, auto-extend view if all markers are visible
  scheduleFitMapToAllMarkers();

  // Final nudge after content & fonts settle
  setTimeout(onViewportChanged, 0);
  setTimeout(onViewportChanged, 300);

      runSelfTests();
    }

    // συμβατότητα με παλιό όνομα
    function renderBoard(){ renderPanels(); }

    // ------------------------------
    // 6) Test cases
    // ------------------------------
    function assert(cond,msg){ if(!cond) throw new Error(msg); }
    function testData(){
      // ΜΗΝ προκαλείς ReferenceError. Έλεγχος λάθους ονόματος με ασφαλή πρόσβαση.
      const wrongSym='NOMOI_MAKEDONΙΑΣ';
      assert(typeof window[wrongSym]==='undefined','Guard: wrong symbol should not exist');
      assert(Array.isArray(NOMOI_MAKEDONIAS),'NOMOI_MAKEDONIAS should be array');
      assert(NOMOI_MAKEDONIAS.length===13,'Πρέπει να υπάρχουν 13 νομοί');
      const set=new Set(NOMOI_MAKEDONIAS.map(x=>x.nomos));
      assert(set.size===13,'Οι νομοί πρέπει να είναι μοναδικοί');
      console.info('✓ TestData passed');
    }
    function testBoardsTwoPanels(){ const n=document.querySelectorAll('#board-nomoi .card').length; const c=document.querySelectorAll('#board-capitals .card').length; assert(n===13 && c===13,'Κάθε πίνακας πρέπει να έχει 13 κάρτες'); console.info('✓ TestBoardsTwoPanels passed'); }
    function testMarkers(){ assert(markerByNomos.size===13,'Πρέπει να υπάρχουν 13 μαρκαδόροι'); showOnlyMarkerForNomos('Κοζάνης'); let ones=0, zeros=0; for (const m of markerByNomos.values()){ const op = m.options.opacity ?? 1; if (op>=1) ones++; else zeros++; } assert(ones===1 && zeros===12, 'Μετά από focus φαίνεται μόνο 1'); console.info('✓ TestMarkers passed'); }
    function testShowAllMarkers(){ showOnlyMarkerForNomos('Κοζάνης'); showAllMarkers(); let ones=0, zeros=0; for (const m of markerByNomos.values()){ const op = m.options.opacity ?? 1; if (op>=1) ones++; else zeros++; } assert(ones===13 && zeros===0, 'Μετά το "Δείξε όλους" είναι ορατοί και οι 13'); console.info('✓ TestShowAllMarkers passed'); }
    function testPreloadMarkersImmediate(){ if(!hasLeaflet) return; assert(markerByNomos.size===13,'Preload: 13 μαρκαδόροι άμεσα'); let ones=0; for (const m of markerByNomos.values()){ const op = m.options.opacity ?? 1; if (op>=1) ones++; } assert(ones===13,'Preload: όλοι ορατοί αρχικά'); console.info('✓ TestPreloadMarkersImmediate passed'); }
    function testResponsiveLayout(){ layoutBoards(); const ok1 = document.getElementById('board-nomoi').scrollHeight <= document.getElementById('board-nomoi').clientHeight + 2; const ok2 = document.getElementById('board-capitals').scrollHeight <= document.getElementById('board-capitals').clientHeight + 2; assert(ok1 && ok2, 'Τα boards δεν πρέπει να ξεχειλίζουν κατακόρυφα'); console.info('✓ TestResponsiveLayout passed'); }
    function testResponsiveTileScaling(){ const boardsEl=document.querySelector('.boards'); const faceSel='#board-nomoi .card .face'; const face=document.querySelector(faceSel); if(!face) return; const fsBefore=parseFloat(getComputedStyle(face).fontSize); const prev=boardsEl.style.gridTemplateColumns; boardsEl.style.gridTemplateColumns='1fr'; layoutBoards(); const fsAfter=parseFloat(getComputedStyle(document.querySelector(faceSel)).fontSize); boardsEl.style.gridTemplateColumns=prev; layoutBoards(); assert(fsAfter>=fsBefore, 'Η γραμματοσειρά καρτών πρέπει να αυξάνει με μεγαλύτερο διαθέσιμο πλάτος'); console.info('✓ TestResponsiveTileScaling passed'); }
    function testDebouncedLayout(){ let count=0; const orig=layoutBoards; layoutBoards=function(){ count++; orig(); }; for(let i=0;i<20;i++) scheduleLayout(); return new Promise((resolve)=>{ requestAnimationFrame(()=>{ const c=count; layoutBoards=orig; assert(c>=1 && c<=2, 'Το scheduleLayout πρέπει να συμπυκνώνει πολλαπλές κλήσεις'); console.info('✓ TestDebouncedLayout passed'); resolve(); }); }); }

    async function runSelfTests(){
      try{
        testData(); testBoardsTwoPanels(); if (hasLeaflet) { testPreloadMarkersImmediate(); testMarkers(); testShowAllMarkers(); } testResponsiveLayout(); testResponsiveTileScaling(); await testDebouncedLayout(); console.info('✓ self-tests passed');
      }catch(err){ console.error('Tests failed:',err); flashStatus('❌ Ένα self-test απέτυχε: '+(err && err.message ? err.message : 'unknown'),'err'); }
    }

    // ------------------------------
    // 7) Κουμπιά
    // ------------------------------
    document.getElementById('btn-new').addEventListener('click',renderBoard);
    document.getElementById('btn-new').addEventListener('click',tryLockLandscape);
    document.getElementById('btn-study').addEventListener('click',()=>{ studyMode=!studyMode; modePill.textContent=studyMode?'Μελέτη':'Κανονικό'; document.querySelectorAll('.card').forEach(c=>c.classList.toggle('flipped',studyMode)); flashStatus(studyMode?'Λειτουργία μελέτης: δες όλα τα ζευγάρια.':'Επιστροφή σε κανονικό παιχνίδι.','ok'); scheduleLayout(); });
    document.getElementById('btn-show-all').addEventListener('click',()=>{ showAllMarkers(); flashStatus('Εμφανίστηκαν όλοι οι μαρκαδόροι.','ok'); });

  // Global resize/orientation handlers to keep scale and orientation consistent
  function onViewportChanged(){
    applyStageScale();
    updateOrientationGuard();
    try{ if(hasLeaflet && map){ map.invalidateSize(); } }catch{}
    scheduleLayout();
    // On viewport changes, extend map to include all markers only when all are visible (avoid interrupting focused views)
    if (hasLeaflet && map) scheduleFitMapToAllMarkers();
  }
  window.addEventListener('resize', onViewportChanged);
  window.addEventListener('orientationchange', () => setTimeout(onViewportChanged, 50));
  // Ensure first-render adaptation without needing a manual resize (mobile/desktop)
  window.addEventListener('load', () => setTimeout(onViewportChanged, 50));
  window.addEventListener('pageshow', () => setTimeout(onViewportChanged, 50));
  if (window.visualViewport) { try { visualViewport.addEventListener('resize', () => setTimeout(onViewportChanged, 0), { passive: true }); } catch {} }

  (async()=>{ await startApp(); })();

    // ------------------------------
    // 8) 16:9 fixed stage scaling and orientation guard
    // ------------------------------

    // Limit mouse interactions globally: only allow clicking the top buttons and scrolling (wheel) on the map
  function setupInteractionGuards(){
      // Prevent context menu, text selection and drag globally
      document.addEventListener('contextmenu', e=> e.preventDefault());
      document.addEventListener('dragstart',   e=> e.preventDefault());
      document.addEventListener('selectstart', e=> e.preventDefault());

      // Disallow page scrolling; map wheel zoom still works
      try{ document.documentElement.style.overflow='hidden'; document.body.style.overflow='hidden'; }catch{}

  const isAllowedButton = (t)=> !!(t && t.closest && t.closest('#btn-new, #btn-study, #btn-show-all'));
  const isGameCard     = (t)=> !!(t && t.closest && t.closest('.card'));
  const isMapArea      = (t)=> !!(t && t.closest && t.closest('#map'));

      const blockIfNotAllowed = (e)=>{
        if (isAllowedButton(e.target) || isGameCard(e.target)) return; // allow clicks on buttons and game cards
        // Everything else (including map clicks) is blocked
        e.stopImmediatePropagation();
        e.preventDefault();
      };

      // Block click-related events globally, except on allowed buttons
      document.addEventListener('click', blockIfNotAllowed, true);
      document.addEventListener('mousedown', blockIfNotAllowed, true);
      document.addEventListener('mouseup', blockIfNotAllowed, true);
      document.addEventListener('dblclick', blockIfNotAllowed, true);

      // Do not block wheel events anywhere, but only the map meaningfully responds (zoom)
      // No handler needed; CSS/Leaflet settings above limit other interactions.
    }

  </script>
</body>
</html>
